<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Openness Studio</title>
    <style>
      body {
        margin: 0;
        display: flex;
        height: 100vh;
        font-family: "Segoe UI", sans-serif;
        background: #1e1e1e;
        color: #ccc;
      }

      #sidebar {
        width: 340px;
        background: #252526;
        border-right: 1px solid #333;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      #sidebar h3 {
        font-size: 14px;
        text-transform: uppercase;
        color: #888;
        padding: 12px 10px 8px 10px;
        margin: 0;
      }

      #menu {
        display: flex;
        gap: 6px;
        padding: 0 10px 10px 10px;
        border-bottom: 1px solid #333;
      }

      .menu-btn {
        background: #2d2d30;
        color: #ccc;
        border: 1px solid #3a3a3a;
        border-radius: 4px;
        padding: 6px 10px;
        font-size: 12px;
        cursor: pointer;
      }

      .menu-btn.active {
        background: #094771;
        color: #fff;
        border-color: #0e639c;
      }

      #file-tree,
      #graph-panel {
        flex: 1;
        overflow: auto;
        padding: 8px;
      }

      .hidden {
        display: none !important;
      }

      .tree-item {
        padding: 4px 5px;
        cursor: pointer;
        display: flex;
        align-items: center;
        font-size: 13px;
        white-space: nowrap;
        user-select: none;
      }

      .tree-item:hover {
        background: #2a2d2e;
      }

      .tree-item.selected {
        background: #37373d;
        color: #fff;
      }

      .icon {
        margin-right: 6px;
        width: 16px;
        min-width: 16px;
        height: 16px;
        display: inline-block;
        background-repeat: no-repeat;
        background-position: center;
        background-size: 16px 16px;
      }

      .icon-folder {
        background-image: url('data:image/svg+xml;utf8,<svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path fill="%23c8a260" d="M1 3h5l1 2h8v8H1z"/><path fill="%23d7ba7d" d="M1 4h14v8H1z"/></svg>');
      }

      .icon-ob {
        background-image: url('data:image/svg+xml;utf8,<svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><rect x="2" y="2" width="12" height="12" fill="%23800080"/><rect x="5" y="5" width="6" height="6" fill="%23D080FF"/></svg>');
      }

      .icon-fb {
        background-image: url('data:image/svg+xml;utf8,<svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><rect x="2" y="2" width="12" height="12" fill="%230000FF"/><rect x="5" y="5" width="6" height="6" fill="%238080FF"/></svg>');
      }

      .icon-fc {
        background-image: url('data:image/svg+xml;utf8,<svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><rect x="2" y="2" width="12" height="12" fill="%23008000"/><rect x="5" y="5" width="6" height="6" fill="%2380FF80"/></svg>');
      }

      .icon-db {
        background-image: url('data:image/svg+xml;utf8,<svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><ellipse cx="8" cy="4" rx="6" ry="2" fill="%234040FF"/><path d="M2,4 v8 a6,2 0 0,0 12,0 v-8" fill="%230000C0"/></svg>');
      }

      .icon-udt {
        background-image: url('data:image/svg+xml;utf8,<svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="2" width="10" height="12" fill="none" stroke="%23cccccc" stroke-width="1"/><line x1="5" y1="5" x2="11" y2="5" stroke="%23cccccc" stroke-width="1"/><line x1="5" y1="8" x2="11" y2="8" stroke="%23cccccc" stroke-width="1"/><line x1="5" y1="11" x2="11" y2="11" stroke="%23cccccc" stroke-width="1"/></svg>');
      }

      .icon-file {
        background-image: url('data:image/svg+xml;utf8,<svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M13.71,4.29l-3-3A1,1,0,0,0,10,1H4A1,1,0,0,0,3,2V14a1,1,0,0,0,1,1H12a1,1,0,0,0,1-1V5A1,1,0,0,0,13.71,4.29ZM10,3.41,11.59,5H10Z" fill="%23cccccc"/></svg>');
      }

      .chevron {
        width: 16px;
        text-align: center;
        color: #ccc;
        font-size: 10px;
        margin-right: 2px;
      }

      .chevron::before {
        content: "▶";
      }

      .chevron.open::before {
        content: "▼";
      }

      .chevron.hidden {
        visibility: hidden;
      }

      #main {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #1e1e1e;
        overflow: hidden;
      }

      #editor-container {
        width: 100%;
        height: 100%;
      }

      .fbd-view {
        padding: 20px;
        overflow: auto;
        height: 100%;
        box-sizing: border-box;
      }

      .fbd-view svg {
        background: #f0f0f0;
      }

      .db-view-container {
        padding: 0;
        height: 100%;
        overflow: auto;
      }

      .graph-header {
        color: #bbb;
        font-size: 12px;
        margin-bottom: 8px;
        line-height: 1.5;
      }

      #graph-canvas {
        width: 100%;
        height: calc(100% - 52px);
        border: 1px solid #333;
        background: #1c1c1d;
      }

      .graph-node {
        cursor: move;
      }

      .graph-node circle {
        stroke: #222;
        stroke-width: 1.5;
      }

      .graph-node text {
        fill: #fff;
        font-size: 11px;
        pointer-events: none;
      }

      .graph-link {
        stroke: #777;
        stroke-width: 1.6;
        marker-end: url(#arrowhead);
      }

      .edge-label {
        fill: #ddd;
        font-size: 10px;
        cursor: pointer;
        text-decoration: underline;
      }

      .graph-help {
        color: #888;
        font-size: 11px;
        margin-top: 6px;
      }

      .graph-usage {
        margin-top: 10px;
        border: 1px solid #333;
        background: #1c1c1d;
      }

      .graph-usage table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
      }

      .graph-usage th,
      .graph-usage td {
        border-bottom: 1px solid #333;
        padding: 6px 8px;
        text-align: left;
      }

      .graph-usage th {
        position: sticky;
        top: 0;
        background: #252526;
      }

      .usage-link {
        color: #4fc1ff;
        cursor: pointer;
        text-decoration: underline;
      }

      #context-menu {
        position: fixed;
        background: #2d2d30;
        border: 1px solid #555;
        border-radius: 6px;
        min-width: 190px;
        z-index: 2000;
        box-shadow: 0 8px 18px rgba(0, 0, 0, 0.45);
        display: none;
        padding: 6px 0;
      }

      #context-menu button {
        width: 100%;
        background: transparent;
        color: #ddd;
        border: none;
        text-align: left;
        padding: 8px 12px;
        font-size: 13px;
        cursor: pointer;
      }

      #context-menu button:hover {
        background: #094771;
      }

      #xref-modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        z-index: 2100;
        display: none;
      }

      #xref-modal {
        position: fixed;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        width: min(760px, 92vw);
        max-height: 82vh;
        overflow: auto;
        background: #252526;
        border: 1px solid #444;
        border-radius: 8px;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.5);
        z-index: 2200;
        display: none;
        color: #ddd;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 14px;
        border-bottom: 1px solid #333;
        font-weight: 600;
      }

      .modal-body {
        padding: 12px 14px;
        font-size: 13px;
      }

      .modal-section {
        margin-bottom: 12px;
      }

      .modal-section h4 {
        margin: 0 0 6px 0;
        color: #9cdcfe;
        font-size: 13px;
      }

      .xref-list {
        margin: 0;
        padding-left: 16px;
        line-height: 1.6;
      }

      .xref-link {
        color: #4fc1ff;
        cursor: pointer;
        text-decoration: underline;
      }

      .modal-close {
        background: #3b3b3b;
        color: #ddd;
        border: 1px solid #555;
        border-radius: 4px;
        padding: 4px 8px;
        cursor: pointer;
      }

      .muted {
        color: #888;
      }
    </style>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.js"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  </head>

  <body>
    <div id="sidebar">
      <h3>Explorer</h3>
      <div id="menu">
        <button id="btn-tree" class="menu-btn active">Tree</button>
        <button id="btn-graph" class="menu-btn">Call Graph</button>
      </div>
      <div id="file-tree">Loading...</div>
      <div id="graph-panel" class="hidden">
        <div class="graph-header">
          Global OB/FB/FC call graph.<br>
          Click node to open block, click edge label to open caller block.
        </div>
        <svg id="graph-canvas"></svg>
        <div class="graph-help">
          Drag nodes to reposition. Positions persist in local storage.
        </div>
        <div id="graph-usage" class="graph-usage"></div>
      </div>
    </div>
    <div id="main">
      <div id="editor-container"></div>
    </div>

    <div id="context-menu">
      <button data-action="xref-from">Show XRef from</button>
      <button data-action="xref-to">Show XRef to</button>
      <button data-action="show-inputs">Show inputs</button>
      <button data-action="show-outputs">Show outputs</button>
      <button data-action="show-in-call-graph">Show in call graph</button>
      <button data-action="type-xref">Show type XRef</button>
    </div>

    <div id="xref-modal-backdrop"></div>
    <div id="xref-modal">
      <div class="modal-header">
        <span id="modal-title">Cross Reference</span>
        <button id="modal-close" class="modal-close">Close</button>
      </div>
      <div id="modal-body" class="modal-body"></div>
    </div>

    <script>
      let editor = null;
      let graphPayload = null;
      let graphSimulation = null;
      let treeData = null;
      let currentContextTarget = null;
      let graphFocusSymbol = null;

      const graphStorageKey = () =>
        `openness-call-graph-pos:${location.pathname}`;

      require.config({
        paths: {
          "vs":
            "https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs",
        },
      });

      window.MonacoEnvironment = {
        getWorkerUrl: function () {
          return `data:text/javascript;charset=utf-8,${
            encodeURIComponent(`
          self.MonacoEnvironment = {
            baseUrl: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/'
          };
          importScripts('https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/base/worker/workerMain.js');`)
          }`;
        },
      };

      require(["vs/editor/editor.main"], function () {});

      function sanitizeIdent(value) {
        const cleaned = String(value || "").replace(
          /[^a-zA-Z0-9_]/g,
          "_",
        );
        return /^[0-9]/.test(cleaned) ? `_${cleaned}` : cleaned;
      }

      function iconClass(node) {
        if (node.type === "Folder" || node.type === "Group") {
          return "icon icon-folder";
        }
        if (node.type === "OB") return "icon icon-ob";
        if (node.type === "FB") return "icon icon-fb";
        if (node.type === "FC") return "icon icon-fc";
        if (node.type === "DB") return "icon icon-db";
        if (node.type === "UDT") return "icon icon-udt";
        return "icon icon-file";
      }

      function setMenu(view) {
        const treeBtn = document.getElementById("btn-tree");
        const graphBtn = document.getElementById("btn-graph");
        const treePanel = document.getElementById("file-tree");
        const graphPanel = document.getElementById("graph-panel");

        if (view === "tree") {
          treeBtn.classList.add("active");
          graphBtn.classList.remove("active");
          treePanel.classList.remove("hidden");
          graphPanel.classList.add("hidden");
        } else {
          treeBtn.classList.remove("active");
          graphBtn.classList.add("active");
          treePanel.classList.add("hidden");
          graphPanel.classList.remove("hidden");
          if (graphPayload) renderCallGraph(graphPayload);
        }
      }

      document.getElementById("btn-tree").addEventListener(
        "click",
        () => setMenu("tree"),
      );
      document.getElementById("btn-graph").addEventListener(
        "click",
        () => setMenu("graph"),
      );

      async function loadTree() {
        const res = await fetch("/api/tree");
        treeData = await res.json();
        const treeRoot = document.getElementById("file-tree");
        treeRoot.innerHTML = "";
        renderTree(treeData, treeRoot);
      }

      async function loadCallGraph() {
        const res = await fetch("/api/call-graph");
        graphPayload = await res.json();
        renderCallGraph(graphPayload);
      }

      async function loadLocalTypes() {
        const res = await fetch("/api/local-types");
        const data = await res.json();
        const list = document.getElementById("local-types-list");
        if (!data.types || data.types.length === 0) {
          list.innerHTML =
            '<div class="muted">No local types found.</div>';
          return;
        }

        list.innerHTML = "";
        data.types.forEach((t) => {
          const row = document.createElement("div");
          row.className = "type-item";
          row.innerHTML =
            `<span class=\"type-name\" title=\"${t.name}\">${t.name}</span><span class=\"type-meta\">${t.sizeBytes}B · ${t.usageCount} uses</span>`;
          row.addEventListener("click", () => {
            if (t.path) {
              setMenu("tree");
              openFile(t.path);
            }
          });
          row.addEventListener("contextmenu", (e) => {
            e.preventDefault();
            openContextMenu(e.clientX, e.clientY, {
              kind: "type",
              typeName: t.name,
              path: t.path || "",
              symbol: "",
            });
          });
          list.appendChild(row);
        });
      }

      function renderTree(node, container, level = 0) {
        const div = document.createElement("div");
        const row = document.createElement("div");
        row.className = "tree-item";
        row.style.paddingLeft = `${level * 10}px`;
        row.setAttribute("data-path", node.path || "");
        row.setAttribute(
          "data-symbol",
          node.blockName ? sanitizeIdent(node.blockName) : "",
        );
        row.setAttribute("data-type", node.type || "");

        let displayName = node.name;
        const isFolder = node.type === "Folder" ||
          node.type === "Group";
        if (node.blockName) {
          displayName = `${node.blockName} [${node.type}${
            node.number !== undefined ? node.number : ""
          }]`;
        }

        const chevron = document.createElement("span");
        chevron.className = "chevron";
        const hasChildren = node.children && node.children.length > 0;
        if (!hasChildren) chevron.classList.add("hidden");

        const icon = document.createElement("span");
        icon.className = iconClass(node);

        const label = document.createElement("span");
        label.textContent = displayName;

        row.appendChild(chevron);
        row.appendChild(icon);
        row.appendChild(label);
        div.appendChild(row);
        container.appendChild(div);

        let childrenContainer = null;
        if (hasChildren) {
          childrenContainer = document.createElement("div");
          childrenContainer.style.display = "none";
          div.appendChild(childrenContainer);
          node.children.forEach((child) =>
            renderTree(child, childrenContainer, level + 1)
          );
        }

        row.addEventListener("contextmenu", (e) => {
          e.preventDefault();
          if (isFolder) return;
          openContextMenu(e.clientX, e.clientY, {
            kind: "block",
            symbol: row.getAttribute("data-symbol") ||
              sanitizeIdent(node.name || ""),
            path: row.getAttribute("data-path") || "",
          });
        });

        row.onclick = () => {
          document.querySelectorAll(".tree-item").forEach((el) =>
            el.classList.remove("selected")
          );
          row.classList.add("selected");

          if (isFolder) {
            if (!childrenContainer) return;
            const isClosed = childrenContainer.style.display === "none";
            childrenContainer.style.display = isClosed
              ? "block"
              : "none";
            chevron.classList.toggle("open", isClosed);
          } else if (node.path) {
            openFile(node.path);
          }
        };
      }

      async function openFile(path) {
        const container = document.getElementById("editor-container");
        if (editor) {
          editor.dispose();
          editor = null;
        }
        container.innerHTML =
          '<div style="color:#666;padding:20px;">Loading...</div>';

        const res = await fetch(
          `/api/file?path=${encodeURIComponent(path)}`,
        );
        if (!res.ok) {
          container.innerHTML = "Error loading file";
          return;
        }
        const data = await res.json();
        container.innerHTML = "";

        if (data.type === "fbd") {
          container.innerHTML =
            `<div class="fbd-view">${data.content}</div>`;
          attachFbdHandlers(container);
          initIfaceTableTree(container);
        } else if (data.type === "db") {
          container.innerHTML =
            `<div class="db-view-container">${data.content}</div>`;
        } else {
          editor = monaco.editor.create(container, {
            value: data.content,
            language: "pascal",
            theme: "vs-dark",
            readOnly: true,
            automaticLayout: true,
          });
        }

        selectInTree(path);
      }

      function attachFbdHandlers(container) {
        container.querySelectorAll("[data-filepath]").forEach(
          (link) => {
            link.addEventListener("click", (e) => {
              e.stopPropagation();
              const dp = link.getAttribute("data-filepath");
              if (dp) openFile(dp);
            });
          },
        );

        container.querySelectorAll(
          "g[data-filepath], g[data-blockname]",
        ).forEach((block) => {
          block.addEventListener("contextmenu", (e) => {
            e.preventDefault();
            const path = block.getAttribute("data-filepath") || "";
            const symbol = sanitizeIdent(
              block.getAttribute("data-blockname") || "",
            );
            openContextMenu(e.clientX, e.clientY, {
              kind: "block",
              symbol,
              path,
            });
          });
        });
      }

      function initIfaceTableTree(container) {
        const rows = Array.from(
          container.querySelectorAll(".iface-member-row"),
        );
        if (!rows.length) return;

        rows.forEach((row) => {
          if (Number(row.getAttribute("data-depth") || 0) > 0) {
            row.classList.add("iface-hidden");
          }
        });

        rows.forEach((row) => {
          if (row.getAttribute("data-has-children") !== "true") return;
          row.addEventListener("click", () => {
            const expanded =
              row.getAttribute("data-expanded") === "true";
            row.setAttribute(
              "data-expanded",
              expanded ? "false" : "true",
            );
            const toggle = row.querySelector(".iface-toggle");
            if (toggle) toggle.textContent = expanded ? "▸" : "▾";
            const rowId = row.getAttribute("data-row-id") || "";
            setIfaceChildrenVisibility(container, rowId, !expanded);
          });
        });
      }

      function setIfaceChildrenVisibility(
        container,
        parentId,
        isVisible,
      ) {
        const children = Array.from(
          container.querySelectorAll(
            `.iface-member-row[data-parent-id="${parentId}"]`,
          ),
        );
        children.forEach((child) => {
          if (isVisible) {
            child.classList.remove("iface-hidden");
          } else {
            child.classList.add("iface-hidden");
            child.setAttribute("data-expanded", "false");
            const toggle = child.querySelector(".iface-toggle");
            if (
              toggle &&
              child.getAttribute("data-has-children") === "true"
            ) {
              toggle.textContent = "▸";
            }
          }

          const childId = child.getAttribute("data-row-id") || "";
          const childExpanded =
            child.getAttribute("data-expanded") === "true";
          setIfaceChildrenVisibility(
            container,
            childId,
            isVisible && childExpanded,
          );
        });
      }

      function selectInTree(path) {
        document.querySelectorAll(".tree-item").forEach((el) =>
          el.classList.remove("selected")
        );
        const target = Array.from(
          document.querySelectorAll(".tree-item"),
        ).find((el) => el.getAttribute("data-path") === path);
        if (!target) return;
        target.classList.add("selected");

        let parent = target.parentElement;
        while (parent && parent.id !== "file-tree") {
          if (parent.style.display === "none") {
            parent.style.display = "block";
            const folderRow = parent.previousSibling;
            if (folderRow?.classList.contains("tree-item")) {
              folderRow.querySelector(".chevron")?.classList.add(
                "open",
              );
            }
          }
          parent = parent.parentElement;
        }
        target.scrollIntoView({ behavior: "smooth", block: "center" });
      }

      function persistNodePositions(nodes) {
        const payload = {};
        nodes.forEach((n) => {
          payload[n.id] = { x: n.x, y: n.y, fx: n.fx, fy: n.fy };
        });
        localStorage.setItem(
          graphStorageKey(),
          JSON.stringify(payload),
        );
      }

      function loadPersistedPositions(nodes, width, height) {
        const raw = localStorage.getItem(graphStorageKey());
        if (!raw) return;
        try {
          const pos = JSON.parse(raw);
          nodes.forEach((n) => {
            if (!pos[n.id]) return;
            const p = pos[n.id];
            n.x = p.x ?? width / 2;
            n.y = p.y ?? height / 2;
            n.fx = p.fx ?? n.x;
            n.fy = p.fy ?? n.y;
          });
        } catch {
          // ignore malformed storage
        }
      }

      function renderCallGraph(payload) {
        const svg = d3.select("#graph-canvas");
        const container = document.getElementById("graph-panel");
        const width = container.clientWidth - 20;
        const height = Math.max(460, container.clientHeight - 78);

        svg.attr("width", width).attr("height", height);
        svg.selectAll("*").remove();

        const nodes = payload.nodes.map((n) => ({
          id: n.name,
          kind: n.kind,
        }));
        const links = payload.edges.map((e) => ({
          source: e.from,
          target: e.to,
          label: `N${e.network} ${e.blockType}`,
          fromPath: e.fromPath,
        }));

        loadPersistedPositions(nodes, width, height);

        const defs = svg.append("defs");
        defs.append("marker")
          .attr("id", "arrowhead")
          .attr("viewBox", "-0 -5 10 10")
          .attr("refX", 18)
          .attr("refY", 0)
          .attr("orient", "auto")
          .attr("markerWidth", 6)
          .attr("markerHeight", 6)
          .append("path")
          .attr("d", "M 0,-5 L 10 ,0 L 0,5")
          .attr("fill", "#777");

        graphSimulation = d3.forceSimulation(nodes)
          .force(
            "link",
            d3.forceLink(links).id((d) => d.id).distance(160),
          )
          .force("charge", d3.forceManyBody().strength(-800))
          .force("center", d3.forceCenter(width / 2, height / 2))
          .force("collide", d3.forceCollide().radius(60));

        const link = svg.append("g")
          .selectAll("line")
          .data(links)
          .join("line")
          .attr("class", "graph-link");

        const edgeLabels = svg.append("g")
          .selectAll("text")
          .data(links)
          .join("text")
          .attr("class", "edge-label")
          .text((d) => d.label)
          .on("click", (_, d) => {
            if (d.fromPath) {
              setMenu("tree");
              openFile(d.fromPath);
            }
          });

        const node = svg.append("g")
          .selectAll("g")
          .data(nodes)
          .join("g")
          .attr("class", "graph-node")
          .call(
            d3.drag()
              .on("start", dragstarted)
              .on("drag", dragged)
              .on("end", dragended),
          );

        node.append("circle")
          .attr("r", 24)
          .attr(
            "fill",
            (d) => {
              if (graphFocusSymbol && d.id === graphFocusSymbol) {
                return "#d19a00";
              }
              return d.kind === "internal" ? "#0e639c" : "#6a9955";
            },
          );

        node.append("text")
          .attr("text-anchor", "middle")
          .attr("dy", 4)
          .text((
            d,
          ) => (d.id.length > 16 ? `${d.id.slice(0, 16)}…` : d.id));

        node.on("click", (_, d) => {
          const path = payload.nodePaths?.[d.id];
          if (path) {
            setMenu("tree");
            openFile(path);
          }
        });

        graphSimulation.on("tick", () => {
          link
            .attr("x1", (d) => d.source.x)
            .attr("y1", (d) => d.source.y)
            .attr("x2", (d) => d.target.x)
            .attr("y2", (d) => d.target.y);

          edgeLabels
            .attr("x", (d) => (d.source.x + d.target.x) / 2)
            .attr("y", (d) => (d.source.y + d.target.y) / 2 - 6);

          node.attr("transform", (d) => `translate(${d.x},${d.y})`);
        });

        function dragstarted(event, d) {
          if (!event.active) graphSimulation.alphaTarget(0.3).restart();
          d.fx = d.x;
          d.fy = d.y;
        }

        function dragged(event, d) {
          d.fx = event.x;
          d.fy = event.y;
        }

        function dragended(event, d) {
          if (!event.active) graphSimulation.alphaTarget(0);
          d.fx = event.x;
          d.fy = event.y;
          persistNodePositions(nodes);
        }

        renderUsageTable(payload);
      }

      function renderUsageTable(payload) {
        const host = document.getElementById("graph-usage");
        const rows = (payload.objects || payload.nodes || []).map(
          (obj) => {
            const key = obj.blockName || obj.name;
            const path = obj.path || payload.nodePaths?.[obj.name] ||
              "";
            return `<tr>
            <td>${escapeHtml(key)}</td>
            <td>${escapeHtml(obj.type || obj.kind || "")}</td>
            <td>${obj.usageCount || 0}</td>
            <td>${obj.outgoingCount || 0}</td>
            <td>${
              path
                ? `<span class="usage-link" data-path="${
                  encodeURIComponent(path)
                }">open</span>`
                : "-"
            }</td>
          </tr>`;
          },
        );

        host.innerHTML = `<table>
          <thead><tr><th>Object</th><th>Type</th><th>Used by</th><th>Calls</th><th>Open</th></tr></thead>
          <tbody>${
          rows.join("") ||
          '<tr><td colspan="5" class="muted">No objects found.</td></tr>'
        }</tbody>
        </table>`;

        host.querySelectorAll(".usage-link").forEach((el) => {
          el.addEventListener("click", () => {
            const path = decodeURIComponent(
              el.getAttribute("data-path") || "",
            );
            if (!path) return;
            setMenu("tree");
            openFile(path);
          });
        });
      }

      function escapeHtml(value) {
        return String(value || "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#39;");
      }

      function openContextMenu(x, y, target) {
        currentContextTarget = target;
        const menu = document.getElementById("context-menu");
        menu.style.left = `${x}px`;
        menu.style.top = `${y}px`;
        menu.style.display = "block";

        const isType = target?.kind === "type";
        menu.querySelectorAll("button").forEach((btn) => {
          const action = btn.getAttribute("data-action");
          if (action === "type-xref") {
            btn.style.display = isType ? "block" : "none";
          } else {
            btn.style.display = isType ? "none" : "block";
          }
        });
      }

      function closeContextMenu() {
        document.getElementById("context-menu").style.display = "none";
      }

      document.addEventListener("click", () => closeContextMenu());
      document.addEventListener(
        "scroll",
        () => closeContextMenu(),
        true,
      );

      async function getXrefData(target) {
        const params = new URLSearchParams();
        if (target.path) params.set("path", target.path);
        if (target.symbol) params.set("symbol", target.symbol);

        const res = await fetch(`/api/xref?${params.toString()}`);
        if (!res.ok) throw new Error(await res.text());
        return await res.json();
      }

      function showModal(title, html) {
        document.getElementById("modal-title").textContent = title;
        document.getElementById("modal-body").innerHTML = html;
        document.getElementById("xref-modal-backdrop").style.display =
          "block";
        document.getElementById("xref-modal").style.display = "block";

        document.querySelectorAll(".xref-link").forEach((a) => {
          a.addEventListener("click", () => {
            const path = a.getAttribute("data-path");
            if (path) {
              setMenu("tree");
              openFile(path);
              closeModal();
            }
          });
        });
      }

      function closeModal() {
        document.getElementById("xref-modal-backdrop").style.display =
          "none";
        document.getElementById("xref-modal").style.display = "none";
      }

      document.getElementById("modal-close").addEventListener(
        "click",
        closeModal,
      );
      document.getElementById("xref-modal-backdrop").addEventListener(
        "click",
        closeModal,
      );

      function renderXrefList(items, type) {
        if (!items?.length) {
          return '<div class="muted">No entries.</div>';
        }
        return `<ul class="xref-list">${
          items.map((x) => {
            const name = x.target || x.source || x.caller || "entry";
            const net = x.network ? ` (network ${x.network})` : "";
            const args = x.args?.length
              ? ` args: ${x.args.join(", ")}`
              : "";
            const extra = x.parameter ? ` param: ${x.parameter}` : "";
            const src = x.sourceExpr ? ` ← ${x.sourceExpr}` : "";
            if (x.path || x.callerPath) {
              return `<li><span class="xref-link" data-path="${
                x.path || x.callerPath
              }">${name}</span>${net}${extra}${src}${args}</li>`;
            }
            return `<li>${name}${net}${extra}${src}${args}</li>`;
          }).join("")
        }</ul>`;
      }

      async function handleContextAction(action) {
        if (!currentContextTarget) return;
        try {
          if (action === "type-xref") {
            const res = await fetch(
              `/api/type-xref?type=${
                encodeURIComponent(currentContextTarget.typeName || "")
              }`,
            );
            if (!res.ok) throw new Error(await res.text());
            const data = await res.json();
            showModal(
              `Type XRef: ${data.type.name} (${data.type.sizeBytes} bytes)`,
              `<div class="modal-section"><h4>Usage count: ${data.type.usageCount}</h4>${
                renderXrefList(
                  (data.usages || []).map((u) => ({
                    source: u.blockName,
                    path: u.path,
                    parameter: `${u.section}.${u.member}`,
                  })),
                  "",
                )
              }</div>`,
            );
            return;
          }

          if (action === "show-in-call-graph") {
            graphFocusSymbol = currentContextTarget.symbol || null;
            setMenu("graph");
            if (graphPayload) renderCallGraph(graphPayload);
            return;
          }

          const data = await getXrefData(currentContextTarget);
          if (action === "xref-from") {
            showModal(
              `XRef from ${data.symbol}`,
              `<div class="modal-section"><h4>Callees</h4>${
                renderXrefList(data.xrefFrom, "from")
              }</div>`,
            );
          } else if (action === "xref-to") {
            showModal(
              `XRef to ${data.symbol}`,
              `<div class="modal-section"><h4>Callers</h4>${
                renderXrefList(data.xrefTo, "to")
              }</div>`,
            );
          } else if (action === "show-inputs") {
            showModal(
              `Inputs for ${data.symbol}`,
              `<div class="modal-section"><h4>Interface Inputs</h4>${
                renderXrefList(
                  data.inputs.interface.map((i) => ({
                    target: `${i.name}: ${i.datatype}`,
                  })),
                  "",
                )
              }</div>
             <div class="modal-section"><h4>Input References</h4>${
                renderXrefList(data.inputs.references, "")
              }</div>`,
            );
          } else if (action === "show-outputs") {
            showModal(
              `Outputs for ${data.symbol}`,
              `<div class="modal-section"><h4>Interface Outputs</h4>${
                renderXrefList(
                  data.outputs.interface.map((i) => ({
                    target: `${i.name}: ${i.datatype}`,
                  })),
                  "",
                )
              }</div>
             <div class="modal-section"><h4>Written Signals</h4>${
                renderXrefList(
                  (data.outputs.writes || []).map((w) => ({
                    target: w,
                  })),
                  "",
                )
              }</div>
             <div class="modal-section"><h4>Output References</h4>${
                renderXrefList(data.outputs.references, "")
              }</div>`,
            );
          }
        } catch (e) {
          showModal("Error", `<div class="muted">${String(e)}</div>`);
        }
      }

      document.querySelectorAll("#context-menu button").forEach(
        (btn) => {
          btn.addEventListener("click", (e) => {
            e.stopPropagation();
            const action = btn.getAttribute("data-action");
            closeContextMenu();
            handleContextAction(action);
          });
        },
      );

      window.addEventListener("resize", () => {
        if (
          !document.getElementById("graph-panel").classList.contains(
            "hidden",
          ) && graphPayload
        ) {
          renderCallGraph(graphPayload);
        }
      });

      Promise.all([loadTree(), loadCallGraph(), loadLocalTypes()]);
    </script>
  </body>
</html>
